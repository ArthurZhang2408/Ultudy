# Ultudy Codebase Cleanup Checklist

## Quick Stats
- **Total Issues:** 24
- **Critical/High:** 8 
- **Medium:** 10
- **Low:** 6
- **Estimated Cleanup Time:** 2-4 hours (excluding architectural decisions)

---

## CRITICAL ISSUES - FIX NOW

### [ ] 1. Remove Unused Import (5 min)
**File:** `/home/user/Ultudy/backend/src/routes/upload.js`  
**Line:** 8
```diff
- import { extractStructuredSections } from '../ingestion/llm_extractor.js';
```
**Why:** Import is defined but never used in this file. The function is only used in the job processor.

---

### [ ] 2. Decide: Unused problem_types Table (30 min)
**Files:** 
- Migration: `/home/user/Ultudy/backend/db/migrations/20251104000000_mvp_v1_schema.cjs`
- RLS Policies: 4 policies (lines 290-336 in same file)

**Options:**
- **A) Implement problem tracking feature** (requires ~2-3 hours)
- **B) Remove table + 4 RLS policies** (requires rollback migration)

**Current Status:** Table exists but is never referenced in codebase (0 usages)

**Recommendation:** Option B (Remove) - No current use case

---

### [ ] 3. Fix Default Configuration Issue (10 min)
**File:** `/home/user/Ultudy/backend/.env.example`  
**Line:** 33
```
SKIP_EMBEDDINGS=true
```

**Issue:** Disables search functionality by default but code doesn't clearly indicate this

**Action:** Either:
- Remove `SKIP_EMBEDDINGS` and always generate embeddings, OR
- Add warning comment explaining search won't work with this setting

---

### [ ] 4. Fix/Update Documentation (1 hour)
**Files:**
- `/home/user/Ultudy/README.md` - Says "PARTIALLY OUTDATED"
- Missing: Current architecture documentation

**What's Wrong:**
- References pgvector/embeddings as core (but they're optional)
- Shows RAG search examples (but chunks aren't generated by default)
- Documentation doesn't match actual implementation

**Action:** Create `/home/user/Ultudy/CURRENT_ARCHITECTURE.md` explaining:
- Vision-based LLM extraction is the primary path
- Full-context lesson generation (no RAG)
- Legacy endpoints and fallback behavior

---

## HIGH PRIORITY - FIX THIS WEEK

### [ ] 5. Document/Remove Deprecated /pdf Endpoint (30 min)
**File:** `/home/user/Ultudy/backend/src/routes/upload.js` (Lines 26-45)

**Current:** Two endpoints that do similar things:
- `POST /upload/pdf` - OLD, uses simple text extraction
- `POST /upload/pdf-structured` - NEW, uses LLM vision extraction

**Action:** Choose one:
- **Option A (Recommended):** Remove old endpoint
- **Option B:** Keep both but add response header: `Deprecation: true`

---

### [ ] 6. Deprecate /sections/generate Endpoint (30 min)
**File:** `/home/user/Ultudy/backend/src/routes/study.js`

**Current Issue:** Endpoint exists for old documents that have `full_text` but no sections

**Action:** 
- Mark with `Deprecation: true` header
- Document it only works for pre-migration documents
- Plan removal once all documents are regenerated

---

### [ ] 7. Archive Demo/Test Scripts (30 min)
**Files to move to `/docs/archived-scripts/`:**
- `demo_improvements.sh`
- `demo_phase3.py`
- `show_improvements.py`
- `test_layout_simple.py`
- `test_positioning.py`
- `test_rich_extraction.sh`
- `compare_extraction.py`

**Action:** Create folder `/home/user/Ultudy/docs/archived-scripts/` and move them there with README

---

## MEDIUM PRIORITY - CLEAN UP THIS MONTH

### [ ] 8. Consolidate Database Setup Scripts (1 hour)
**Files to consolidate:**
- `/home/user/Ultudy/backend/scripts/create-jobs-table.js`
- `/home/user/Ultudy/backend/scripts/setup-jobs-table.sh`
- `/home/user/Ultudy/backend/scripts/setup-jobs-table-simple.js`

**Action:** Keep only one approach, document clearly

---

### [ ] 9. Clarify PDF Extraction Architecture (1-2 hours)
**Files involved:**
- `/home/user/Ultudy/backend/src/ingestion/extractor.js` - Main router
- `/home/user/Ultudy/backend/src/ingestion/extractor-enhanced.js` - Deterministic extraction
- `/home/user/Ultudy/backend/src/ingestion/llm_extractor.js` - Vision-based (NEW)

**Current State:** 4 different extraction methods co-exist
- `auto` mode - Legacy (tries Python, falls back to pdf-parse)
- `standard` mode - Legacy (pdf-parse only)
- `enhanced` mode - Active (Python deterministic)
- Vision-based - NEW/ACTIVE (LLM in upload processor)

**Action:**
1. Document which method is primary (Vision-based)
2. Mark legacy methods as deprecated
3. Clean up unused extraction scripts:
   - Keep: `extract_text_deterministic.py` (for `enhanced` mode)
   - Keep: `extract_text.py` (for legacy `auto` mode)
   - **Remove:** `extract_text_vision.py` (not used - superseded by LLM)

---

### [ ] 10. Remove/Consolidate Utility Scripts (30 min)
**Files:**
- `/home/user/Ultudy/backend/delete-sections.js` - Keep (useful for regeneration)
- `/home/user/Ultudy/backend/scripts/clear-cached-lessons.js` - Keep (useful for dev)
- `/home/user/Ultudy/backend/scripts/check-ivfflat-support.js` - Keep (pgvector check)

**Action:** Add to main scripts directory with clear naming

---

## LOW PRIORITY - NICE TO HAVE

### [ ] 11. Consolidate Frontend Utility Imports
**Issue:** Helper functions imported with different relative paths in different files

**Fix:** Create `/frontend/src/app/api/utils.ts` that re-exports common utilities

---

### [ ] 12. Clean Up Legacy Fallback Logic
**File:** `/home/user/Ultudy/backend/src/jobs/processors/lesson.processor.js` (Lines 140-160)

**Action:** Add note documenting this is for legacy documents only

---

### [ ] 13. Update Database Documentation
**Add to README or new file:**
- Document `chunks` table is optional (skipped by default)
- Document `problem_types` table status
- Document `concepts` table usage
- Add query examples for common patterns

---

## Decision Points for Product Team

Before implementing cleanup, need decisions on:

1. **PDF Extraction:**
   - Keep `enhanced` mode for legacy docs? (YES/NO)
   - Keep `auto` mode for fallback? (YES/NO)

2. **Search Functionality:**
   - Is RAG search still needed? (YES/NO)
   - If NO, remove chunks table and search service

3. **Legacy Document Support:**
   - How long keep /sections/generate endpoint? (timeline needed)
   - Migrate all docs to new format or maintain two paths? (decision needed)

4. **Problem Types Feature:**
   - Is this coming soon? (timeline)
   - If NO, remove table from database

---

## Commit Strategy

### Commit 1: Critical Cleanup
```
Remove unused imports and fix default configuration

- Remove unused extractStructuredSections import from upload.js
- Add clarifying comment to SKIP_EMBEDDINGS default
- Consolidate database setup scripts
- Archive demo/test scripts
```

### Commit 2: Deprecation Notices
```
Add deprecation headers to old endpoints

- Mark /upload/pdf as deprecated
- Mark /sections/generate as deprecated
- Document migration path in README
```

### Commit 3: Documentation
```
Create comprehensive architecture documentation

- Add CURRENT_ARCHITECTURE.md
- Update README to remove outdated content
- Document extraction modes and choices
- Document table schemas and usage
```

### Commit 4: (Optional) Database Cleanup
```
Remove unused database table (after decision)

- Create rollback migration for problem_types table
- Remove 4 RLS policies
- Update migration documentation
```

---

## Testing Needed After Cleanup

- [ ] Verify /upload/pdf-structured still works
- [ ] Verify /sections/generate works for legacy docs
- [ ] Verify lesson generation (with and without check-ins)
- [ ] Verify search doesn't break (if keeping chunks)
- [ ] Run all tests: `npm test` in backend

---

## Estimated Timeline

| Phase | Tasks | Effort | Timeline |
|-------|-------|--------|----------|
| 1 | Critical fixes + documentation | 4-6 hours | This week |
| 2 | High priority deprecations | 2-3 hours | This week |
| 3 | Medium priority cleanup | 2-3 hours | Next week |
| 4 | Low priority improvements | 1-2 hours | Optional |

**Total:** ~10-15 hours over 2 weeks

---

Generated: 2025-11-16  
Total Issues Found: 24  
Report Location: `/tmp/code_analysis_report.md`
